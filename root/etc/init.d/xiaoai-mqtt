#!/bin/sh /etc/rc.common

USE_PROCD=1
START=99
STOP=10
DEPENDS="samba4-client etherwake"

start_service() {
    # 检查服务是否启用
    local enabled
    config_load 'xiaoai-mqtt'
    config_get enabled 'main' 'enabled' '0'
    
    if [ "$enabled" != "1" ]; then
        logger -t xiaoai-mqtt "Service is disabled in config"
        return 0
    fi

    # 清理残留进程和文件（优化版，减少系统调用）
    # 使用更高效的进程查找方法
    local pid_file="/var/run/xiaoai-mqtt.pid"
    local sub_pid_file="/var/run/mosquitto_sub.pid"
    
    # 如果存在PID文件，读取并终止进程
    if [ -f "$pid_file" ]; then
        local pid=$(cat "$pid_file" 2>/dev/null)
        [ -n "$pid" ] && kill -TERM "$pid" 2>/dev/null
    fi
    
    if [ -f "$sub_pid_file" ]; then
        local sub_pid=$(cat "$sub_pid_file" 2>/dev/null)
        [ -n "$sub_pid" ] && kill -9 "$sub_pid" 2>/dev/null
    fi
    
    # 清理文件
    rm -f /var/run/mosquitto_sub.pid /tmp/mosquitto_sub.out /var/run/xiaoai-mqtt.pid /var/run/xiaoai-mqtt.status
    
    # 创建状态文件
    touch /var/run/xiaoai-mqtt.status
    chmod 644 /var/run/xiaoai-mqtt.status

    # 设置权限（只在需要时）
    [ ! -x "/etc/xiaoai-mqtt/mqtt_client.lua" ] && chmod 755 /etc/xiaoai-mqtt/mqtt_client.lua
    [ ! -x "/etc/xiaoai-mqtt/status.sh" ] && chmod 755 /etc/xiaoai-mqtt/status.sh

    # 创建日志文件
    [ ! -f "/var/log/xiaoai-mqtt.log" ] && touch /var/log/xiaoai-mqtt.log
    chmod 644 /var/log/xiaoai-mqtt.log
    
    # 清理旧的日志轮转文件（优化版，使用更高效的方法）
    for i in 5 6 7 8 9 10; do
        [ -f "/var/log/xiaoai-mqtt.log.$i" ] && rm -f "/var/log/xiaoai-mqtt.log.$i"
    done

    # 注册服务进程
    procd_open_instance
    procd_set_param command /usr/bin/lua "/etc/xiaoai-mqtt/mqtt_client.lua"
    procd_set_param respawn
    procd_set_param respawn_threshold 3600
    procd_set_param respawn_timeout 5
    procd_set_param respawn_retry 5
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_set_param pidfile "/var/run/xiaoai-mqtt.pid"
    # 设置环境变量，确保脚本能够正确访问系统资源
    procd_set_param env PATH=/usr/sbin:/usr/bin:/sbin:/bin
    procd_close_instance

    # 添加启动后验证（减少日志记录）
    sleep 1
    if [ -f /var/run/xiaoai-mqtt.pid ]; then
        logger -t xiaoai-mqtt "服务启动成功"
    else
        logger -t xiaoai-mqtt "警告：PID文件未生成"
    fi
}

stop_service() {
    # 终止主进程
    local pid=$(pgrep -f "/usr/bin/lua /etc/xiaoai-mqtt/mqtt_client.lua")
    [ -n "$pid" ] && kill -TERM $pid 2>/dev/null

    # 强制终止所有关联进程（包括mosquitto_sub）
    pgrep -f "mosquitto_sub -h bemfa.com" | xargs kill -9 2>/dev/null
   

    # 清理状态文件
    echo "mqtt_connection=disconnected" > /var/run/xiaoai-mqtt.status
    echo "last_action=服务已停止" >> /var/run/xiaoai-mqtt.status

    # 移除PID文件
    rm -f /var/run/xiaoai-mqtt.pid
}

reload_service() {
    # 使用HUP信号触发日志轮转
    local pid=$(pgrep -f "/usr/bin/lua /etc/xiaoai-mqtt/mqtt_client.lua")
    [ -n "$pid" ] && kill -HUP $pid
}
