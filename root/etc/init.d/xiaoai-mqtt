#!/bin/sh /etc/rc.common

USE_PROCD=1
START=99
STOP=10
DEPENDS="samba4-client etherwake"

start_service() {
    # 检查服务是否启用
    local enabled
    config_load 'xiaoai-mqtt'
    config_get enabled 'main' 'enabled' '0'
    
    if [ "$enabled" != "1" ]; then
        logger -t xiaoai-mqtt "Service is disabled in config"
        return 0
    fi

    # 清理残留进程和文件
    local pid=$(pgrep -f "/usr/bin/lua /etc/xiaoai-mqtt/mqtt_client.lua")
    [ -n "$pid" ] && {
        kill -TERM $pid 2>/dev/null
        sleep 2
    }
    local sub_pid=$(pgrep -f "mosquitto_sub -h bemfa.com")
    [ -n "$sub_pid" ] && kill -9 $sub_pid 2>/dev/null
    
    rm -f /var/run/mosquitto_sub.pid /tmp/mosquitto_sub.out /var/run/xiaoai-mqtt.pid
    # 添加权限验证日志
    logger -t xiaoai-mqtt "验证安装目录权限: $(ls -ld /etc/xiaoai-mqtt)"
    logger -t xiaoai-mqtt "验证主程序权限: $(ls -l /etc/xiaoai-mqtt/mqtt_client.lua)"
    logger -t xiaoai-mqtt "验证状态脚本权限: $(ls -l /etc/xiaoai-mqtt/status.sh)"
    rm -f /var/run/xiaoai-mqtt.status
    touch /var/run/xiaoai-mqtt.status
    chmod 644 /var/run/xiaoai-mqtt.status

    # 确保脚本和目录权限
    chmod 755 /etc/xiaoai-mqtt
    chmod 755 /etc/xiaoai-mqtt/mqtt_client.lua
    chmod 755 /etc/xiaoai-mqtt/status.sh

    # 创建日志文件
    touch /var/log/xiaoai-mqtt.log
    chmod 644 /var/log/xiaoai-mqtt.log

    # 注册服务进程
    procd_open_instance
    procd_set_param command /usr/bin/lua "/etc/xiaoai-mqtt/mqtt_client.lua"
    procd_set_param respawn
    procd_set_param respawn_threshold 3600
    procd_set_param respawn_timeout 5
    procd_set_param respawn_retry 5
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_set_param pidfile "/var/run/xiaoai-mqtt.pid"
    # 设置环境变量，确保脚本能够正确访问系统资源
    procd_set_param env PATH=/usr/sbin:/usr/bin:/sbin:/bin
    procd_close_instance

    # 添加启动后验证
    sleep 2
    [ -f /var/run/xiaoai-mqtt.pid ] && {
        logger -t xiaoai-mqtt "服务启动成功 PID: $(cat /var/run/xiaoai-mqtt.pid)"
    } || {
        logger -t xiaoai-mqtt "错误：PID文件未生成，请检查执行权限"
        ls -l /usr/bin/lua /etc/xiaoai-mqtt/mqtt_client.lua >> /var/log/xiaoai-mqtt.log
    }
    
    # 检查必要依赖
    which mosquitto_sub >/dev/null 2>&1 || logger -t xiaoai-mqtt "严重错误：未找到mosquitto_sub命令"
    logger -t xiaoai-mqtt "Service started successfully with enhanced permissions"
}

stop_service() {
    # 终止主进程
    local pid=$(pgrep -f "/usr/bin/lua /etc/xiaoai-mqtt/mqtt_client.lua")
    [ -n "$pid" ] && kill -TERM $pid 2>/dev/null

    # 强制终止所有关联进程（包括mosquitto_sub）
    pgrep -f "mosquitto_sub -h bemfa.com" | xargs kill -9 2>/dev/null
   

    # 清理状态文件
    echo "mqtt_connection=disconnected" > /var/run/xiaoai-mqtt.status
    echo "last_action=服务已停止" >> /var/run/xiaoai-mqtt.status

    # 移除PID文件
    rm -f /var/run/xiaoai-mqtt.pid
}

reload_service() {
    # 使用HUP信号触发日志轮转
    local pid=$(pgrep -f "/usr/bin/lua /etc/xiaoai-mqtt/mqtt_client.lua")
    [ -n "$pid" ] && kill -HUP $pid
}