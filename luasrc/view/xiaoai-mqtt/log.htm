<%+header%>
<div class="cbi-map">
    <h2><%:XiaoAi MQTT æ—¥å¿—ç®¡ç†%></h2>
    
    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="cbi-section log-stats">
        <h3><%:æ—¥å¿—ç»Ÿè®¡%></h3>
        <div class="stats-grid">
            <div class="stat-item">
                <span class="label"><%:æ–‡ä»¶å¤§å°%>:</span>
                <span class="value"><%= luci.util.exec("ls -lh /var/log/xiaoai-mqtt.log 2>/dev/null | awk '{print $5}'") or "0B" %></span>
            </div>
            <div class="stat-item">
                <span class="label"><%:æ—¥å¿—æ¡ç›®%>:</span>
                <span class="value"><%= luci.util.exec("wc -l /var/log/xiaoai-mqtt.log 2>/dev/null | awk '{print $1}'") or "0" %></span>
            </div>
        </div>
    </div>

    <!-- æ—¥å¿—å†…å®¹ -->
    <div class="cbi-section log-content">
        <h3><%:å®æ—¶æ—¥å¿—%></h3>
        <pre class="log-output">
            <%= luci.sys.exec("tail -n 100 /var/log/xiaoai-mqtt.log") or "æš‚æ— æ—¥å¿—å†…å®¹..." %>
        </pre>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="cbi-section log-actions">
        <div class="cbi-page-actions">
            <form class="inline" method="post" action="<%= url('admin/services/xiaoai-mqtt/clear_log') %>">
                <button type="submit" class="cbi-button cbi-button-reset">
                    ğŸ—‘ï¸ <%:æ¸…ç©ºæ—¥å¿—%>
                </button>
            </form>
            
            <button class="cbi-button cbi-button-neutral" onclick="refreshLog(); return false;">
                ğŸ”„ <%:åˆ·æ–°æ—¥å¿—%>
            </button>

            <a class="cbi-button cbi-button-apply" 
               href="<%= url('admin/services/xiaoai-mqtt/download_log') %>">
                â¬‡ï¸ <%:ä¸‹è½½æ—¥å¿—%>
            </a>
        </div>
    </div>
</div>

<link rel="stylesheet" href="<%=resource%>/view/xiaoai-mqtt/style.css">

<script>
// è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
let autoRefresh = true;

function refreshLog() {
    if(autoRefresh) {
        fetch('<%= luci.dispatcher.build_url("admin/services/xiaoai-mqtt/log") %>')
            .then(r => r.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                document.querySelector('.log-output').innerHTML = 
                    doc.querySelector('.log-output').innerHTML;
                document.querySelector('.stats-grid').innerHTML = 
                    doc.querySelector('.stats-grid').innerHTML;
            });
    }
}

// æ¯5ç§’åˆ·æ–°
setInterval(refreshLog, 5000);

// é¼ æ ‡æ‚¬åœæ—¶æš‚åœè‡ªåŠ¨åˆ·æ–°
document.querySelector('.log-output').addEventListener('mouseenter', () => {
    autoRefresh = false;
});
document.querySelector('.log-output').addEventListener('mouseleave', () => {
    autoRefresh = true;
});
</script>

<%+footer%>